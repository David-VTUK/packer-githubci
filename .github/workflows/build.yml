name: Build

on: [pull_request, workflow_dispatch]

jobs:
  debug:
    runs-on: self-hosted
    steps:
      - run: env
  packer:
    runs-on: self-hosted
    name: packer

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      # fix backwards incompatibilities in template
      - name: Fix Template
        uses: hashicorp/packer-github-actions@master
        with:
          command: fix
          target: ./test/ubuntu-2004.json

      # validate templates
      - name: Validate Template
        uses: hashicorp/packer-github-actions@master
        with:
          command: validate
          arguments: -syntax-only
          target: ./test/ubuntu-2004.json

      # build artifact
      - name: Build Artifact
        uses: hashicorp/packer-github-actions@master
        with:
          command: build
          arguments: "-color=false -on-error=abort -var 'vcenter_server=${{ secrets.VCENTER_SERVER }}' -var 'username=${{ secrets.USERNAME }}' -var 'password=${{ secrets.PASSWORD }}' -var 'datastore=${{ secrets.DATASTORE }}' -var 'folder=${{ secrets.FOLDER }}' -var 'host=${{ secrets.HOST }}' -var 'cluster=${{ secrets.CLUSTER }}' -var 'network=${{ secrets.NETWORK }}' -var 'ssh_username=${{ secrets.SSH_USERNAME }}' -var 'ssh_password=${{ secrets.SSH_PASSWORD }}'"
          target: ./test/ubuntu-2004.json